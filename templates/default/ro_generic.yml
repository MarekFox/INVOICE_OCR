# Uniwersalny szablon dla rumuńskich faktur
issuer: "Szablon Ogólny Rumuński"
description: "Domyślny szablon dla faktur w języku rumuńskim"
language: "Rumuński"
priority: 1

keywords:
  - "FACTURĂ"
  - "FACTURA"
  - "CUI"
  - "FURNIZOR"
  - "CUMPĂRĂTOR"
  - "TVA"

exclude_keywords: []

fields:
  invoice_id:
    parser: regex
    patterns:
      - '(?:Factur[aă]|Seria)[:\s]*([A-Z]+\s*[0-9]+)'
      - 'Nr\.\s*([0-9]+)'
      - 'Serie[:\s]*([A-Z]+)\s*Nr[:\s]*([0-9]+)'
    group: 1
    required: true

  invoice_type:
    parser: keyword_detection
    mapping:
      "STORNO": "KOREKTA"
      "CORECTIE": "KOREKTA"
      "PROFORMA": "PROFORMA"
      "AVANS": "ZALICZKOWA"
    default: "VAT"

  issue_date:
    parser: date
    keywords:
      - "DATA EMITERII"
      - "Data emiterii"
      - "DATA"
    patterns:
      - '\d{2}\.\d{2}\.\d{4}'
      - '\d{2}/\d{2}/\d{4}'
    formats:
      - '%d.%m.%Y'
      - '%d/%m/%Y'
    search_range: 150
    required: true

  sale_date:
    parser: date
    keywords:
      - "DATA LIVRĂRII"
      - "Data livrarii"
    patterns:
      - '\d{2}\.\d{2}\.\d{4}'
    formats:
      - '%d.%m.%Y'
    fallback: "use_issue_date"

  due_date:
    parser: date
    keywords:
      - "TERMEN DE PLATĂ"
      - "SCADENȚĂ"
      - "Data scadentei"
    patterns:
      - '\d{2}\.\d{2}\.\d{4}'
    formats:
      - '%d.%m.%Y'
    fallback: "add_days:30"

  supplier_name:
    parser: context_extraction
    keywords:
      - "FURNIZOR"
      - "VÂNZĂTOR"
      - "PRESTATOR"
    extraction_strategy: "next_line"
    fallback: "NOT_FOUND"
    required: true

  supplier_tax_id:
    parser: regex
    patterns:
      - '(?:CUI|CIF|C\.U\.I)[:\s]*(RO\s?\d{2,10})'
      - '(?:CUI|CIF)[:\s]*(\d{2,10})'
    validator: cui
    group: 1
    context_keywords:
      - "FURNIZOR"
      - "VÂNZĂTOR"
    context_range: 300
    required: true

  supplier_address:
    parser: address_extraction
    context_keywords:
      - "FURNIZOR"
    patterns:
      - '([A-ZĂÎÂȘȚ][a-zăîâșț]+,?\s+(?:str\.|Str\.)\s+[^,]+)'
    context_range: 400

  supplier_accounts:
    parser: bank_accounts
    patterns:
      - '(?:RO\s?)?\d{2}\s?[A-Z]{4}\s?\d{4}\s?\d{4}\s?\d{4}\s?\d{4}'
      - 'IBAN[:\s]*([A-Z]{2}\d{2}[A-Z0-9\s]+)'
    validator: iban
    multiple: true

  buyer_name:
    parser: context_extraction
    keywords:
      - "CUMPĂRĂTOR"
      - "CLIENT"
      - "BENEFICIAR"
    extraction_strategy: "next_line"
    fallback: "NOT_FOUND"
    required: true

  buyer_tax_id:
    parser: regex
    patterns:
      - '(?:CUI|CIF)[:\s]*(RO\s?\d{2,10})'
      - '(?:CUI|CIF)[:\s]*(\d{2,10})'
    validator: cui
    group: 1
    context_keywords:
      - "CUMPĂRĂTOR"
      - "CLIENT"
    context_range: 300

  total_gross:
    parser: money
    keywords:
      - "TOTAL DE PLATĂ"
      - "TOTAL GENERAL"
      - "TOTAL"
      - "SUMA"
    patterns:
      - '(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)\s*(?:lei|RON|LEI)'
    currency: "RON"
    decimal_separator: ","
    thousand_separator: "."
    required: true

  total_net:
    parser: money
    keywords:
      - "TOTAL FĂRĂ TVA"
      - "VALOARE FĂRĂ TVA"
    patterns:
      - '(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)\s*(?:lei|RON)?'
    currency: "RON"
    fallback: "calculate_from_gross:19"

  total_vat:
    parser: money
    keywords:
      - "TVA"
      - "VALOARE TVA"
    patterns:
      - '(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)\s*(?:lei|RON)?'
    currency: "RON"
    fallback: "calculate_difference"

  currency:
    parser: static
    value: "RON"

lines:
  enabled: true
  start:
    patterns:
      - 'Nr\.?\s*crt|NR'
      - 'Denumire.*Cantitate.*Preț'
  end:
    patterns:
      - 'Total|TOTAL'
  line_pattern: '^(\d+)\s+(.+?)\s+([\d,\.]+)\s+([\d,\.]+)\s+([\d,\.]+)$'
  line_fields:
    - name: position
      group: 1
      type: int
    - name: description
      group: 2
      type: string
    - name: quantity
      group: 3
      type: decimal
    - name: price_unit
      group: 4
      type: decimal
    - name: total
      group: 5
      type: decimal

options:
  remove_whitespace: true
  date_tolerance_days: 365
  amount_tolerance: 0.02
  tax_id_assignment_strategy: "context_proximity"
  validate_iban: true
  debug_mode: false

metadata:
  author: "System"
  version: "1.0"
  created: "2025-11-29"
